# MimeParserBenchmark

This project benchmarks various .NET MIME parsers for comparison purposes.

## Package Versions

| Package                                                                | Version                                                                             |
|-----------------------------------------------------------------------:|:-----------------------------------------------------------------------------------:|
| <a href="https://github.com/jstedfast/MimeKit">MimeKit</a>             | <a href="https://www.nuget.org/packages/MimeKit/2.15.0">2.15.0</a>                  |
| <a href="https://www.limilabs.com/mail">LimiLabs' Mail.dll</a>         | <a href="https://www.nuget.org/packages/Mail.dll/3.0.21231.1234">3.0.21231.1234</a> |
| <a href="http://www.mime4.net/">Mime4Net</a>                           | <a href="https://www.nuget.org/packages/NI.Email.Mime/1.8.1">1.8.1</a>              |
| <a href="https://github.com/andyedinborough/aenetmail">AE.Net.Mail</a> | <a href="https://www.nuget.org/packages/AE.Net.Mail/1.7.10">1.7.10</a>              |
| <a href="https://github.com/pmengal/MailSystem.NET">MailSystem.NET</a> | <a href="https://www.nuget.org/packages/MailSystem.NET/2.0.1">2.0.1</a>             |
| <a href="https://github.com/foens/hpop">OpenPOP.NET</a>                | <a href="https://www.nuget.org/packages/OpenPop.NET/2.0.6.1120">2.0.6.1120</a>      |

## Runtime

```
BenchmarkDotNet=v0.13.1, OS=Windows 10.0.19043.1165 (21H1/May2021Update)
Intel Core i7-9700 CPU 3.00GHz, 1 CPU, 8 logical and 8 physical cores
  [Host]     : .NET Framework 4.8 (4.8.4300.0), X64 RyuJIT  [AttachedDebugger]
  DefaultJob : .NET Framework 4.8 (4.8.4300.0), X64 RyuJIT
```

## Results

### HeavyHeaderEmailBenchmark

In this benchmark, each library is used to parse an in-memory email message that is almost all headers 1,000 times.

|            Method |        Mean |     Error |    StdDev |
|------------------ |------------:|----------:|----------:|
|           MimeKit |    35.96 ms |  0.259 ms |  0.230 ms |
| MimeKitPersistent |    36.10 ms |  0.263 ms |  0.246 ms |
|          LimiLabs |   654.01 ms |  7.326 ms |  6.852 ms |
|          Mime4Net |   552.90 ms |  3.303 ms |  3.090 ms |
|           OpenPOP |   353.91 ms |  2.916 ms |  2.585 ms |
|         AENetMail | 2,830.32 ms | 23.561 ms | 22.039 ms |
|     MailSystemNET | 1,993.27 ms | 31.395 ms | 29.367 ms |

### JwzMboxBenchmark

In this benchmark, each library is used to parse the `jwz.mbox` Unix mbox spool from disk 10 times.

|            Method |       Mean |   Error |  StdDev |
|------------------ |-----------:|--------:|--------:|
|           MimeKit |   189.9 ms | 1.39 ms | 1.30 ms |
| MimeKitPersistent |   169.0 ms | 1.07 ms | 0.90 ms |
|          LimiLabs | 1,155.7 ms | 7.89 ms | 7.38 ms |

### StarTrekEmailBenchmark

In this benchmark, each library is used to parse `startrek.eml` from disk 1,000 times.

|            Method |        Mean |    Error |   StdDev |
|------------------ |------------:|---------:|---------:|
|           MimeKit |    244.6 ms |  1.38 ms |  1.22 ms |
| MimeKitPersistent |    218.1 ms |  2.64 ms |  2.47 ms |
|          LimiLabs |  2,433.9 ms | 21.50 ms | 20.11 ms |
|          Mime4Net | 11,056.2 ms | 41.99 ms | 32.78 ms |
|           OpenPOP |          NA |       NA |       NA |
|         AENetMail |  4,008.8 ms | 52.67 ms | 49.27 ms |
|     MailSystemNET |  9,492.8 ms | 54.95 ms | 48.71 ms |

Notes:
* MailSystem.NET's parser only supports parsing from byte[] or MemoryStream, so in this test,
  MailSystem.NET is allowed to "cheat" by parsing an in-memory version of the message instead
  of being forced to parse from disk in each iteration.
* OpenPOP.NET fails to parse this message with the following exception:

```
System.Reflection.TargetInvocationException: Exception has been thrown by the target of an invocation. ---> System.ArgumentException: Media Type must be in the format type "/" subtype
Parameter name: mediaType
   at OpenPop.Mime.Header.HeaderFieldParser.cleanMediaType(String mediaType)
   at OpenPop.Mime.Header.HeaderFieldParser.ParseContentType(String headerValue)
   at OpenPop.Mime.Header.MessageHeader.ParseHeader(String headerName, String headerValue)
   at OpenPop.Mime.Header.MessageHeader.ParseHeaders(NameValueCollection headers)
   at OpenPop.Mime.Header.HeaderExtractor.ExtractHeadersAndBody(Byte[] fullRawMessage, MessageHeader& headers, Byte[]& body, IParsingErrorHandler parsingErrorHandler)
   at OpenPop.Mime.MessagePart.ParseMultiPartBody(Byte[] rawBody)
   at OpenPop.Mime.MessagePart.ParseMultiPartBody(Byte[] rawBody)
   at OpenPop.Mime.Message.Load(Stream messageStream, IParsingErrorHandler parsingErrorHandler)
   at Benchmarks.StarTrekEmailBenchmarks.OpenPOP()
   at BenchmarkDotNet.Autogenerated.Runnable_14.WorkloadActionNoUnroll(Int64 invokeCount)
   at BenchmarkDotNet.Engines.Engine.RunIteration(IterationData data)
   at BenchmarkDotNet.Engines.EngineFactory.Jit(Engine engine, Int32 jitIndex, Int32 invokeCount, Int32 unrollFactor)
   at BenchmarkDotNet.Engines.EngineFactory.CreateReadyToRun(EngineParameters engineParameters)
   at BenchmarkDotNet.Autogenerated.Runnable_14.Run(IHost host, String benchmarkName)
   --- End of inner exception stack trace ---
   at System.RuntimeMethodHandle.InvokeMethod(Object target, Object[] arguments, Signature sig, Boolean constructor)
   at System.Reflection.RuntimeMethodInfo.UnsafeInvokeInternal(Object obj, Object[] parameters, Object[] arguments)
   at System.Reflection.RuntimeMethodInfo.Invoke(Object obj, BindingFlags invokeAttr, Binder binder, Object[] parameters, CultureInfo culture)
   at BenchmarkDotNet.Autogenerated.UniqueProgramName.AfterAssemblyLoadingAttached(String[] args)
```

### Xamarin3EmailBenchmark

In this benchmark, each library is used to parse `xamarin3.eml` from disk 1,000 times.


|            Method |     Mean |    Error |   StdDev |
|------------------ |---------:|---------:|---------:|
|           MimeKit |  1.948 s | 0.0209 s | 0.0196 s |
| MimeKitPersistent |  1.474 s | 0.0121 s | 0.0114 s |
|          LimiLabs | 13.147 s | 0.0331 s | 0.0310 s |
|          Mime4Net | 90.343 s | 0.5334 s | 0.4989 s |
|           OpenPOP | 80.331 s | 0.4005 s | 0.3747 s |
|         AENetMail | 30.106 s | 0.1540 s | 0.1441 s |
|     MailSystemNET | 49.939 s | 0.2709 s | 0.2402 s |

Notes:
* MailSystem.NET's parser only supports parsing from byte[] or MemoryStream, so in this test,
  MailSystem.NET is allowed to "cheat" by parsing an in-memory version of the message instead
  of being forced to parse from disk in each iteration.

### Conclusions

Yea. No contest. MimeKit mops the floor with all of the other parsers out there.

How does **your** MIME parser compare?
